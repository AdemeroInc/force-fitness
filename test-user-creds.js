const { VertexAI } = require('@google-cloud/vertexai');
const fs = require('fs');

async function testWithUserCredentials() {
  try {
    console.log('🔑 Using default application credentials (your user account)...');
    
    // Use default credentials (your gcloud auth)
    const vertex = new VertexAI({
      project: 'force-fitness-1753281211',
      location: 'us-central1'
      // No explicit credentials - will use gcloud auth
    });
    
    console.log('📝 Testing Gemini first...');
    const textModel = vertex.getGenerativeModel({
      model: 'gemini-1.5-flash',
    });
    
    const textResult = await textModel.generateContent('Say hello in one word');
    console.log('✅ Gemini works:', textResult.response.text());
    
    console.log('\n🎨 Now testing Imagen 3...');
    const imageModel = vertex.getGenerativeModel({
      model: 'imagen-3.0-fast-generate-001',
    });
    
    const imageResult = await imageModel.generateContent({
      prompt: 'A blue fitness dumbbell icon, simple and clean design',
      aspectRatio: '1:1',
      personGeneration: 'dont_allow'
    });
    
    console.log('✅ Image generated successfully!');
    
    // Save the image
    const response = imageResult.response;
    if (response.candidates && response.candidates[0]) {
      const candidate = response.candidates[0];
      if (candidate.content && candidate.content.parts && candidate.content.parts[0]) {
        const part = candidate.content.parts[0];
        if (part.inlineData && part.inlineData.data) {
          const imageData = Buffer.from(part.inlineData.data, 'base64');
          fs.writeFileSync('test2.png', imageData);
          console.log('💾 Image saved as test2.png (Generated by Imagen 3!)');
          console.log(`📊 Image size: ${imageData.length} bytes`);
          return;
        }
      }
    }
    
    console.log('⚠️ No image data found in response');
    console.log('Response structure:', JSON.stringify(response, null, 2));
    
  } catch (error) {
    console.log('❌ Error:', error.message);
    
    if (error.message.includes('404')) {
      console.log('\n💡 Still getting 404 - let\'s try some alternatives:');
      console.log('1. Try different model names');
      console.log('2. Check if there\'s a region-specific requirement');
      console.log('3. Verify billing is properly linked');
    }
  }
}

testWithUserCredentials();